<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
Important:
If you use the gzipped or `INCLUDE_FALLBACK_INDEX_HTM` options, please remember
to rerun the `reduce_index.sh` script located in the `extras` subfolder and recompile
the sketch after each change to this file.
-->
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>高级文件管理器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="\system\favicon.ico"
      type="image/vnd.microsoft.icon"
    />
    <link
      rel="icon"
      href="\system\favicon.ico"
      type="image/vnd.microsoft.icon"
    />
    <style>
      @font-face {
        font-family: "iconfont";
        src: url("/system/iconfont.ttf") format("truetype");
      }
    </style>
    <style>
      :root {
        --primary-bg: #0a0e17;
        --secondary-bg: #111827;
        --card-bg: #1a2234;
        --accent-cyan: #00d4ff;
        --accent-magenta: #ff006e;
        --accent-green: #00ff88;
        --accent-orange: #ff6b35;
        --text-primary: #f0f4f8;
        --text-secondary: #94a3b8;
        --border-color: #2d3748;
        --glow-cyan: 0 0 20px rgba(0, 212, 255, 0.5);
        --glow-magenta: 0 0 20px rgba(255, 0, 110, 0.5);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        width: 100vw;
        height: 100vh;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px),
          linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
        z-index: 0;
      }

      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(ellipse at top, rgba(0, 212, 255, 0.08) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
      }

      input:not([type="file"]),
      button {
        padding: 0.4em 0.8em;
        border-width: 2px;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      input:not([type="file"]) {
        border: 2px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        outline: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      input:not([type="file"]):focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: var(--glow-cyan);
      }

      input:not([type="file"])::placeholder {
        color: var(--text-secondary);
      }

      select {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        padding: 0.5em 1em;
        min-height: 40px;
        line-height: 1.4;
        transition: all 0.3s ease;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
      }

      select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: var(--glow-cyan);
      }

      select option {
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 10px;
      }

      #language_select {
        display: inline-flex;
        align-items: center;
      }

      button {
        cursor: pointer;
        background: linear-gradient(135deg, var(--accent-cyan), #00a8cc);
        border: none;
        color: var(--primary-bg);
        outline: none;
        transition: all 0.3s ease;
        font-weight: 700;
        font-family: 'Arial Black', 'Impact', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.8rem;
        position: relative;
        overflow: hidden;
      }

      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: var(--glow-cyan);
      }

      button:focus {
        background: linear-gradient(135deg, #00a8cc, var(--accent-cyan));
        box-shadow: var(--glow-cyan);
      }
    </style>
    <style>
      #loading {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 9999999;
        display: none;
        width: 100vw;
        height: 100vh;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-primary);
        background: rgba(10, 14, 23, 0.9);
        backdrop-filter: blur(10px);
      }

      #loading.shown {
        display: flex;
      }

      #loading-msg {
        display: inline-block;
        color: var(--accent-cyan);
        font-size: 1.5rem;
        font-family: 'Arial Black', 'Impact', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 20px;
      }

      @keyframes spinner-anim {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* :not(:required) hides this rule from IE9 and below */
      #loading .spinner-anim:not(:required) {
        display: inline-block;
        animation: spinner-anim 1s infinite linear;
        border: 4px solid var(--border-color);
        border-right-color: var(--accent-cyan);
        border-radius: 100%;
        box-sizing: border-box;
        text-indent: -9999px;
        width: 3em;
        height: 3em;
        box-shadow: var(--glow-cyan);
      }

      #loading .spinner-anim span {
        display: none;
      }
    </style>
    <style>
      .contextMenu {
        z-index: 300;
        position: absolute;
        left: 5px;
        border: 2px solid var(--border-color);
        background: var(--card-bg);
        display: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        min-width: 150px;
      }
      .contextMenu ul {
        list-style: none;
        top: 0;
        left: 0;
        margin: 0;
        padding: 8px 0;
      }
      .contextMenu li {
        position: relative;
        min-width: 60px;
        cursor: pointer;
        padding: 0;
      }
      .contextMenu span {
        color: var(--text-primary);
        display: inline-block;
        padding: 10px 16px;
        transition: all 0.2s ease;
      }
      .contextMenu li:hover {
        background: var(--accent-cyan);
      }
      .contextMenu li:hover span {
        color: var(--primary-bg);
      }
    </style>
    <style type="text/css" media="screen">
      #header {
        flex: 0 0 auto;
        display: flex;
        flex-wrap: wrap;
        padding: 12px 16px;
        background: var(--secondary-bg);
        border-bottom: 2px solid var(--border-color);
        gap: 10px;
      }

      #header > * {
        display: inline-flex;
        flex: 0 0 auto;
        box-sizing: border-box;
      }

      #status {
        align-items: center;
        color: var(--accent-cyan);
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
      }
      .css-treeview {
        width: 100%;
        overflow: auto;
        padding: 12px;
        background: var(--secondary-bg);
        border-right: 2px solid var(--border-color);
      }
      .css-treeview ul,
      .css-treeview li {
        list-style: none;
      }
      .css-treeview input {
        display: none;
      }
      .css-treeview span {
        color: var(--text-primary);
        white-space: nowrap;
        padding: 0 0.5em;
        transition: all 0.2s ease;
      }
      .css-treeview span:hover {
        text-decoration: none;
        color: var(--accent-cyan);
        text-shadow: var(--glow-cyan);
      }
      .css-treeview input + label + ul {
        margin: 0 0 0 1em;
      }
      .css-treeview input ~ ul {
        display: none;
      }
      .css-treeview input:checked:not(:disabled) ~ ul {
        display: block;
      }
      .css-treeview label,
      .css-treeview label::before,
      .css-treeview span,
      .css-treeview span::before {
        cursor: pointer;
      }

      .css-treeview label::before,
      .css-treeview span::before {
        margin-right: 8px;
        font-family: "iconfont" !important;
        font-size: 16px;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: var(--accent-cyan);
        transition: all 0.2s ease;
      }
      .css-treeview label::before {
        content: "\e66b";
      }
      .css-treeview input:checked + label::before {
        content: "\e66a";
        color: var(--accent-magenta);
      }
      .css-treeview span::before {
        content: "\e669";
      }
      .css-treeview span.txt::before {
        content: "\e667";
      }
      .css-treeview span.img::before {
        content: "\e668";
      }
      .css-treeview input:checked + label::before {
        background-position: 0 -16px;
      }

      #tree-show {
        flex: 1 1 100%;
        display: flex;
        background: var(--primary-bg);
      }
      #editor,
      #preview {
        display: none;
        width: 100%;
        justify-content: center;
        align-items: center;
        background: var(--card-bg);
        color: var(--text-primary);
      }

      @media (min-width: 751px) {
        body {
          background-color: var(--primary-bg);
        }

        #header {
          flex-wrap: nowrap;
          align-items: center;
        }

        #header > * + * {
          margin-left: 5px;
        }

        #header > input:nth-child(3) {
          flex: 1 1 100%;
        }
      }

      @media (max-width: 750px) {
        body {
          background-color: var(--primary-bg);
        }

        #header {
          padding: 10px 12px;
          gap: 8px;
        }

        #header > input {
          width: 100%;
          margin-bottom: 8px;
          font-size: 0.85rem;
        }

        #header > button {
          margin-right: 5px;
          font-size: 0.75rem;
          padding: 0.5em 1em;
        }

        #tree {
          width: 100%;
        }

        #tree-show {
          position: fixed;
          width: 0;
          height: 0;
        }

        #editor,
        #preview {
          position: fixed;
          top: 0;
          left: 0;
          padding: 1em;
          box-sizing: border-box;
          width: 100vw;
          height: 100vh;
          background-color: var(--card-bg);
          color: var(--text-primary);
          z-index: 1000;
        }

        .show-close {
          position: absolute;
          z-index: 99999999;
          top: 1em;
          right: 1em;
          width: 2em;
          height: 2em;
          cursor: pointer;
          background: var(--accent-magenta);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: var(--glow-magenta);
        }

        .show-close::before,
        .show-close::after {
          content: "";
          position: absolute;
          top: 50%;
          left: 50%;
          display: flex;
          width: 60%;
          height: 3px;
          background: var(--text-primary);
          transition: all 0.4s;
        }

        .show-close::before {
          transform: translate(-50%, -50%) rotate(45deg);
        }

        .show-close::after {
          transform: translate(-50%, -50%) rotate(-45deg);
        }

        .css-treeview {
          padding: 10px;
        }

        .css-treeview span {
          font-size: 0.85rem;
        }
      }

      @media (max-width: 480px) {
        #header {
          padding: 8px 10px;
          gap: 6px;
        }

        #header > input {
          font-size: 0.8rem;
        }

        #header > button {
          font-size: 0.7rem;
          padding: 0.4em 0.8em;
        }

        .css-treeview span {
          font-size: 0.8rem;
          padding: 0 0.4em;
        }

        #loading-msg {
          font-size: 1.2rem;
        }

        @media (max-width: 750px) {
          select {
            font-size: 0.85rem;
            padding: 0.4em 0.8em;
            min-height: 36px;
            padding-right: 30px;
          }

          #language_select {
            width: 100%;
          }
        }

        @media (max-width: 480px) {
          select {
            font-size: 0.8rem;
            padding: 0.4em 0.7em;
            min-height: 34px;
          }
        }
      }

      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: var(--secondary-bg);
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--accent-cyan), var(--accent-magenta));
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, var(--accent-magenta), var(--accent-cyan));
      }

      ::-webkit-scrollbar-corner {
        background: var(--secondary-bg);
      }
    </style>
    <script src="jquery.js"></script>
    <script src="system/lan/index.js"></script>
    <script>
      var tree; // 编辑器需要在保存时刷新文件大小
      var fsInfo; // 需要更改SPIFFS上的刷新路径行为
      /////////////////////////
      // UTILS

      function showClose(e) {
        e.target.parentNode.style.display = "none";
      }

      function setLoading(show, message) {
        if (message) console.log(message);
        document.getElementById("loading-msg").innerHTML = message
          ? message
          : "";
        if (show) document.getElementById("loading").classList.add("shown");
        else document.getElementById("loading").classList.remove("shown");
        document.body.style.cursor = show ? "wait" : "default";
      }

      function readableSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + " KB";
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        if (bytes < 1024 * 1024 * 1024 * 1024) return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
        return (bytes / (1024 * 1024 * 1024 * 1024)).toFixed(2) + " TB";
      }

      function refreshStatus() {
        // document.getElementById("status").innerHTML = "(刷新中...)";
        document.getElementById("status").innerHTML =
          "(" + language.shuaxinzhong + "...)";
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onload = function () {
          if (xmlHttp.status != 200) showHttpError(xmlHttp);
          else {
            fsInfo = JSON.parse(xmlHttp.responseText);
            var status = fsInfo.type + "->";
            if (fsInfo.isOk) {
              var usedPercent = Math.round((fsInfo.usedBytes / fsInfo.totalBytes) * 100);
              var text = readableSize(fsInfo.usedBytes) + "/" + readableSize(fsInfo.totalBytes);
              status +=
                "<span id='fsPercent' style='color: var(--accent-cyan); font-weight: bold;'>" +
                usedPercent +
                "%</span> " +
                "(" +
                text +
                ")";
              if (fsInfo.unsupportedFiles) {
                status +=
                  " <span id='warning'>WARNING<span class='tooltip'>" +
                  "Filesystem&nbsp;contains&nbsp;unsupported&nbsp;filenames:<br/>" +
                  fsInfo.unsupportedFiles +
                  "</span></span>";
              }
            } else {
              status +=
                "<span style='background-color:red;color:white;font-weight:bold'>INIT ERROR !</span>";
            }
            document.getElementById("status").innerHTML = status;
            if (fsInfo.type != "SPIFFS") {
              document.getElementById("mkdir").style.display = "inline";
            }
          }
        };
        xmlHttp.open("GET", "/status", true);
        xmlHttp.send(null);
      }

      function showHttpError(request) {
        alert("ERROR: [" + request.status + "] " + request.responseText);
      }

      function canLoadNewContents() {
        // The fact the save button is enabled indicates the editor has unsaved changes
        // if (document.getElementById("saveBtn").disabled) return true;
        // if (confirm("如果继续，对文档的更改将丢失")) {
        //   enableSaveDiscardBtns(false);
        //   return true;
        // }
        // return false;
      }

      function enableSaveDiscardBtns(enabled) {
        /*document.getElementById("saveBtn").disabled = !enabled;
        document.getElementById("discardBtn").disabled = !enabled;*/
      }

      /*
       * Returns the parent folder of a given path
       * ""      > ""
       * "/"     > ""
       * "a"     > ""
       * "/a"    > ""
       * "a/"    > ""
       * "/a/"   > ""
       * "a/b"   > "/a"
       * "/a/b"  > "/a"
       * "a/b/"  > "/a"
       * "/a/b/" > "/a"
       */
      function getParentFolder(path) {
        if (!path.startsWith("/")) path = "/" + path;
        if (path.endsWith("/")) path = path.slice(0, -1);
        return path.substring(0, path.lastIndexOf("/"));
      }

      /////////////////////////
      // HEADER with uploader, buttons ans status

      function createHeader(element, tree, editor) {
        var header = document.getElementById(element);
        var xmlHttp;

        var fileSelector = document.createElement("input");
        fileSelector.type = "file";
        fileSelector.multiple = false;
        fileSelector.name = "data";
        header.appendChild(fileSelector);

        var fileLanguageSelector = document.createElement("div");
        fileLanguageSelector.style.cssText +=
          "display: flex;align-items: center;";
        header.appendChild(fileLanguageSelector);

        var fileLanguageSelectorBtn = document.createElement("button");
        fileLanguageSelectorBtn.style.cssText += "padding: 5px 10px;";
        fileLanguageSelector.appendChild(fileLanguageSelectorBtn);

        var fileLanguageSelectorSpan = document.createElement("span");
        fileLanguageSelectorSpan.innerHTML = language.xuanzewenjian;
        fileLanguageSelectorSpan.style.cssText +=
          "font-size: .9em;line-height: 1em;";
        fileLanguageSelectorBtn.appendChild(fileLanguageSelectorSpan);

        // 点击自定义文字时触发原生文件选择框
        fileLanguageSelector.addEventListener("click", () =>
          fileSelector.click()
        );
        fileSelector.style.display = "none";

        var pathInput = document.createElement("input");
        pathInput.id = "pathInput";
        pathInput.type = "text";
        pathInput.name = "path";
        pathInput.defaultValue = "/";
        header.appendChild(pathInput);

        var upload = document.createElement("button");
        // upload.innerHTML = "上传";
        upload.innerHTML = language.shangchuan;
        header.appendChild(upload);

        var mkdir = document.createElement("button");
        mkdir.id = "mkdir";
        mkdir.style.display = "none";
        // mkdir.innerHTML = "新建文件夹";
        mkdir.innerHTML = language.xinjianwenjianjia;
        header.appendChild(mkdir);

        var mkfile = document.createElement("button");
        // mkfile.innerHTML = "新建文件";
        mkfile.innerHTML = language.xinjianwenjian;
        header.appendChild(mkfile);

        var status = document.createElement("span");
        status.id = "status";
        // status.innerHTML = "(加载)";
        status.innerHTML = "(" + language.jiazai + ")";
        header.appendChild(status);

        var languageSelectDiv = document.createElement("div");
        var languageSelect = document.createElement("select");
        languageSelectDiv.id = "language_select";
        languageSelectDiv.appendChild(languageSelect);
        header.appendChild(languageSelectDiv);

        fileSelector.onchange = function (e) {
          // A file has been selected
          if (fileSelector.files.length === 0) return;
          var filename = fileSelector.files[0].name;
          if (mustFormat83()) {
            filename = to83(filename);
          }
          if (!pathInput.value.startsWith("/"))
            pathInput.value = "/" + pathInput.value;
          pathInput.value = getParentFolder(pathInput.value) + "/" + filename;
        };

        upload.onclick = function (e) {
          if (fileSelector.files.length === 0) return;
          tree.httpUpload(fileSelector.files[0], pathInput.value);
        };

        function mustFormat83() {
          return false; // TODO: if needed, test fsInfo.type (and fatType ?)
        }

        function to83(filename) {
          var ext = /(?:\.([^.]+))?$/.exec(filename)[1];
          var name = /(.*)\.[^.]+$/.exec(filename)[1];
          if (name !== undefined) {
            if (name.length > 8) name = name.substring(0, 8);
            filename = name;
          }
          if (ext !== undefined) {
            if (ext === "html") ext = "htm";
            else if (ext === "jpeg") ext = "jpg";
            filename = filename + "." + ext;
          }
          return filename;
        }

        mkfile.onclick = function (e) {
          var path = pathInput.value.trim();
          if (path === "") alert("A filename must be given");
          else if (path.endsWith("/"))
            alert("Filenames must not end with a '/' character");
          else tree.httpCreate(path);
        };

        mkdir.onclick = function (e) {
          var path = pathInput.value.trim();
          if (path === "") alert("A folder name must be given");
          else {
            if (!path.endsWith("/")) path = path + "/";
            tree.httpCreate(path);
          }
        };
      }

      /////////////////////////
      // FILE TREE

      function createTree(element, editor) {
        var preview = document.getElementById("preview");
        var treeRoot = document.createElement("div");
        treeRoot.className = "css-treeview";
        treeRoot.id = "/";
        document.getElementById(element).appendChild(treeRoot);

        function loadDownload(path) {
          document.getElementById("download-frame").src =
            path + "?download=true";
        }

        /* 显示图片 */
        function loadImgPreview(path) {
          const size = document
            .getElementById(path)
            .getElementsByTagName("i")[0]
            .innerHTML.replace(/[()（）]/g, "");
          const l = size.length;
          const s = size
            .slice(l - 2, l)
            .toLowerCase()
            .replace(/\s*/g, "");
          const n = parseFloat(size);
          if ((s === "kb" && n < 1024) || (s === "b" && n < 1024 * 1024)) {
            document.getElementById(path);
            document.getElementById("pathInput").value = path;
            document.getElementById("editor").style.display = "none";
            // document.getElementById("editorButtons").style.display = "none";
            preview.style.display = "flex";
            preview.innerHTML =
              "<div class='show-close'></div><img src='" +
              path +
              "' style='max-width:100%; max-height:100%; margin:auto; display:block;' />";
            const close = preview.querySelectorAll(".show-close")[0];
            close.onclick = showClose;
          }
        }

        /* 显示文件 */
        // Fall back code used when ace.js is not available (neither online or local)
        function loadTxtPreview(path) {
          const size = document
            .getElementById(path)
            .getElementsByTagName("i")[0]
            .innerHTML.replace(/[()（）]/g, "");
          const l = size.length;
          const s = size
            .slice(l - 2, l)
            .toLowerCase()
            .replace(/\s*/g, "");
          const n = parseFloat(size);
          if ((s === "kb" && n < 1024) || (s === "b" && n < 1024 * 1024)) {
            document.getElementById("pathInput").value = path;
            document.getElementById("editor").style.display = "none";
            // document.getElementById("editorButtons").style.display = "none";
            preview.style.display = "flex";
            preview.innerHTML =
              "<div class='show-close'></div><span style='color:red;'>" +
              // '无法加载ACE编辑器，默认为文本查看器。'
              language.wufajiazaiACEbianjiqi +
              "<br></span><pre id='txtContents' style='overflow: auto;'></pre>";
            const close = preview.querySelectorAll(".show-close")[0];
            close.onclick = showClose;
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
              document.getElementById("txtContents").textContent =
                this.responseText;
            };
            xhr.open("GET", path);
            xhr.send();
          }
        }

        this.clearMainPanel = function () {
          document.getElementById("editor").style.display = "none";
          // document.getElementById("editorButtons").style.display = "none";
          preview.style.display = "flex";
          preview.innerHTML =
            "<div class='show-close'></div><div style='color: #fff'>(" +
            // 找不到文件或不支持格式
            language.zhaobudaowenjianhuobuzhichigeshi +
            ")</div>";
          const close = preview.querySelectorAll(".show-close")[0];
          close.onclick = showClose;
        };

        function isTextFile(path) {
          var ext = /(?:\.([^.]+))?$/.exec(path)[1];
          if (ext !== undefined) {
            switch (ext.toLowerCase()) {
              case "txt":
              case "htm":
              case "html":
              case "js":
              case "json":
              case "c":
              case "h":
              case "cpp":
              case "css":
              case "xml":
              case "config":
              case "watch":
              case "z1":
              case "z2":
              case "i1":
              case "i2":
                return true;
            }
          }
          return false;
        }

        function isImageFile(path) {
          var ext = /(?:\.([^.]+))?$/.exec(path)[1];
          if (ext !== undefined) {
            switch (ext.toLowerCase()) {
              case "png":
              case "jpg":
              case "jpeg":
              case "gif":
              case "ico":
              case "bmp":
                return true;
            }
          }
          return false;
        }

        function fillFolderMenu(el, path) {
          var list = document.createElement("ul");
          el.appendChild(list);
          var action = document.createElement("li");
          list.appendChild(action);
          var isChecked = document.getElementById(path).childNodes[0].checked;
          var expnd = document.createElement("li");
          list.appendChild(expnd);
          if (isChecked) {
            // expnd.innerHTML = "<span>折叠</span>";
            expnd.innerHTML = "<span>" + language.zhedie + "</span>";
            expnd.onclick = function (e) {
              if (
                document.body.getElementsByClassName("contextMenu").length > 0
              )
                document.body.removeChild(el);
              document.getElementById(path).childNodes[0].checked = false;
            };
            var refrsh = document.createElement("li");
            list.appendChild(refrsh);
            // refrsh.innerHTML = "<span>刷新</span>";
            refrsh.innerHTML = "<span>" + language.shuaxin + "</span>";
            refrsh.onclick = function (e) {
              if (
                document.body.getElementsByClassName("contextMenu").length > 0
              )
                document.body.removeChild(el);
              httpList(path);
            };
          } else {
            expnd.innerHTML = "<span>Expand</span>";
            expnd.onclick = function (e) {
              if (
                document.body.getElementsByClassName("contextMenu").length > 0
              )
                document.body.removeChild(el);
              document.getElementById(path).childNodes[0].checked = true;
              httpList(path);
            };
          }
          var renFolder = document.createElement("li");
          list.appendChild(renFolder);
          // renFolder.innerHTML = "<span>重命名/移动</span>";
          renFolder.innerHTML =
            "<span>" +
            language.chongmingming +
            "/" +
            language.yidong +
            "</span>";
          renFolder.onclick = function (e) {
            if (document.body.getElementsByClassName("contextMenu").length > 0)
              document.body.removeChild(el);
            var newPath = prompt("Rename " + path + " to", path);
            if (newPath != null && newPath != path) {
              httpRename(path, newPath);
            }
          };
          var delFolder = document.createElement("li");
          list.appendChild(delFolder);
          // delFolder.innerHTML = "<span>删除</span>";
          delFolder.innerHTML = "<span>" + language.shanchu + "</span>";
          delFolder.onclick = function (e) {
            if (document.body.getElementsByClassName("contextMenu").length > 0)
              document.body.removeChild(el);
            httpDelete(path);
          };
        }

        function fillFileMenu(el, path) {
          var list = document.createElement("ul");
          el.appendChild(list);
          var action = document.createElement("li");
          list.appendChild(action);
          if (isTextFile(path)) {
            if (typeof ace == "undefined") {
              // Could not load editor
              // action.innerHTML = "<span>观看</span>";
              action.innerHTML = "<span>" + language.guankan + "</span>";
              action.onclick = function (e) {
                if (
                  document.body.getElementsByClassName("contextMenu").length > 0
                )
                  document.body.removeChild(el);
                if (canLoadNewContents()) loadTxtPreview(path);
              };
            } else {
              // action.innerHTML = "<span>编辑</span>";
              action.innerHTML = "<span>" + language.bianji + "</span>";
              action.onclick = function (e) {
                if (
                  document.body.getElementsByClassName("contextMenu").length > 0
                )
                  document.body.removeChild(el);
                if (canLoadNewContents()) editor.loadUrl(path);
              };
            }
          } else if (isImageFile(path)) {
            // action.innerHTML = "<span>预览</span>";
            action.innerHTML = "<span>" + language.yulan + "</span>";
            action.onclick = function (e) {
              if (
                document.body.getElementsByClassName("contextMenu").length > 0
              )
                document.body.removeChild(el);
              if (canLoadNewContents()) loadImgPreview(path);
            };
          }
          var download = document.createElement("li");
          list.appendChild(download);
          // download.innerHTML = "<span>下载</span>";
          download.innerHTML = "<span>" + language.xiazai + "</span>";
          download.onclick = function (e) {
            if (document.body.getElementsByClassName("contextMenu").length > 0)
              document.body.removeChild(el);
            loadDownload(path);
          };
          var renFile = document.createElement("li");
          list.appendChild(renFile);
          // renFile.innerHTML = "<span>重命名/移动</span>";
          renFile.innerHTML =
            "<span>" +
            language.chongmingming +
            "/" +
            language.yidong +
            "</span>";
          renFile.onclick = function (e) {
            if (document.body.getElementsByClassName("contextMenu").length > 0)
              document.body.removeChild(el);
            var newPath = prompt("Rename " + path + " to", path);
            if (newPath != null && newPath != path) {
              httpRename(path, newPath);
            }
          };
          var delFile = document.createElement("li");
          list.appendChild(delFile);
          // delFile.innerHTML = "<span>删除</span>";
          delFile.innerHTML = "<span>" + language.shanchu + "</span>";
          delFile.onclick = function (e) {
            if (document.body.getElementsByClassName("contextMenu").length > 0)
              document.body.removeChild(el);
            httpDelete(path);
          };
          // if ()
          var close = document.createElement("li");
          list.appendChild(close);
          // close.innerHTML = "<span>关闭</span>";
          close.innerHTML = "<span>" + language.guanbi + "</span>";
          close.onclick = function (e) {
            [...document.querySelectorAll(".contextMenu")].forEach((dom) => {
              document.body.removeChild(dom);
            });
          };
        }

        function showContextMenu(e, path, isfile) {
          [...document.querySelectorAll(".contextMenu")].forEach((dom) => {
            document.body.removeChild(dom);
          });
          var divContext = document.createElement("div");
          var scrollTop = document.body.scrollTop
            ? document.body.scrollTop
            : document.documentElement.scrollTop;
          var scrollLeft = document.body.scrollLeft
            ? document.body.scrollLeft
            : document.documentElement.scrollLeft;
          var left = e.clientX + scrollLeft;
          var top = e.clientY + scrollTop;
          divContext.className = "contextMenu";
          divContext.style.display = "block";
          divContext.style.left = left + "px";
          divContext.style.top = top + "px";
          if (isfile) fillFileMenu(divContext, path);
          else fillFolderMenu(divContext, path);
          document.body.appendChild(divContext);
          var width = divContext.offsetWidth;
          var height = divContext.offsetHeight;
          divContext.onmouseout = function (e) {
            if (
              e.clientX < left ||
              e.clientX > left + width ||
              e.clientY < top ||
              e.clientY > top + height
            ) {
              if (
                document.body.getElementsByClassName("contextMenu").length > 0
              )
                document.body.removeChild(divContext);
            }
          };
        }

        /* 树形图文件点击事件 */
        function createTreeLeaf(parentPath, name, size) {
          var leaf = document.createElement("li");
          leaf.id = (parentPath == "/" ? "" : parentPath) + "/" + name;
          var span = document.createElement("span");
          span.classList.add("iconfont");
          if (isTextFile(name)) span.classList.add("txt");
          else if (isImageFile(name)) span.classList.add("img");
          span.innerHTML = name + "<i>(" + readableSize(size) + ")</i>";
          leaf.appendChild(span);
          leaf.onclick = function (e) {
            attemptLoad(leaf.id);
          };
          leaf.oncontextmenu = function (e) {
            e.preventDefault();
            e.stopPropagation();
            showContextMenu(e, leaf.id, true);
          };
          return leaf;
        }

        /* 树形图文件夹点击事件 */
        function createTreeBranch(parentPath, name, disabled) {
          var leaf = document.createElement("li");
          leaf.id = (parentPath == "/" ? "" : parentPath) + "/" + name;
          var check = document.createElement("input");
          check.type = "checkbox";
          if (typeof disabled !== "undefined" && disabled)
            check.disabled = "disabled";
          leaf.appendChild(check);
          var label = document.createElement("label");
          label.textContent = name;
          leaf.appendChild(label);
          check.onchange = function (e) {
            if (check.checked) {
              httpList(leaf.id);
            }
          };
          /* 目录点击事件 */
          label.onclick = function (e) {
            if (!check.checked) {
              /* 文件目录展开手风琴模式 */
              [...leaf.parentNode.children]
                .filter(
                  (dom) => dom.querySelectorAll('[type="checkbox"]').length > 0
                )
                .map((dom) => {
                  const c = dom.querySelector('[type="checkbox"]');
                  if (c.checked) c.checked = false;
                });
              leaf.classList.add("unfold");
              check.checked = true;
              httpList(leaf.id);
            } else {
              check.checked = false;
            }
          };
          leaf.oncontextmenu = function (e) {
            e.preventDefault();
            e.stopPropagation();
            showContextMenu(e, leaf.id, false);
          };
          return leaf;
        }

        function addFileNodes(parentPath, items) {
          items.sort(function (a, b) {
            if (a.type == b.type) {
              return a.name.localeCompare(b.name); // a before z
            } else {
              return a.type.localeCompare(b.type); // dir before file
            }
          });
          var list = document.createElement("ul");

          document.getElementById(parentPath).appendChild(list);
          var ll = items.length;
          for (var i = 0; i < ll; i++) {
            var item = items[i];
            var itemEl;
            if (item.type === "file")
              itemEl = createTreeLeaf(parentPath, item.name, item.size);
            else itemEl = createTreeBranch(parentPath, item.name);
            list.appendChild(itemEl);
          }
        }

        /* 文件展示事件 */
        this.attemptLoad = function (path) {
          console.log(
            "Attempting load of '" + path + "'...",
            canLoadNewContents()
          );
          document.getElementById("pathInput").value = path;
          // if (canLoadNewContents()) {
          if (isTextFile(path)) {
            if (typeof ace == "undefined") {
              loadTxtPreview(path);
            } else {
              editor.loadUrl(path);
            }
          } else if (isImageFile(path)) loadImgPreview(path);
          else clearMainPanel();
          // }
        };

        /*
         * Refresh the given path, e.g. "/a/b/c/d"
         * It means we have to make sure d is already displayed
         * If not, we get to its parent first (c), if open, and so on (b, a).
         * Once we have found an ancestor, we refresh it, then we must come back to where we started, refreshing nodes on our way down.
         * This is done by pushing all paths to be refreshed in an array that will be pop'd in the callback function
         */
        this.refreshPath = function (path) {
          if (fsInfo.type == "SPIFFS") {
            // on SPIFFS : No parent node => refresh full tree
            console.log("Refreshing '/'...");
            httpList("/");
          } else {
            console.log("Refreshing '" + path + "'...");
            if (path.lastIndexOf("/") == -1) {
              // No "/" => reset the root
              httpList("/");
            } else {
              var paths = [];
              // Climb the tree until we get to an open node, adding paths to the array
              var parentPath = path;
              while (
                parentPath.lastIndexOf("/") != -1 &&
                !document.getElementById(parentPath)
              ) {
                paths.push(parentPath);
                parentPath = getParentFolder(parentPath);
              }

              // If we've reached the top
              if (parentPath == "") paths.push("/"); // list the root
              else paths.push(parentPath); // otherwise list the last folder

              // And list it back down by iterating on collected paths
              listPaths(paths);
            }
          }
        };

        //////////////////////////////
        // HTTP OPERATIONS

        // Callbacks

        function onListReceived(req, parentPath, remainingPaths) {
          return function () {
            setLoading(false);
            if (req.status != 200) showHttpError(req);
            else {
              // Remove previous child list, if any
              var parentEl = document.getElementById(parentPath);
              if (parentEl) {
                var lastChild = parentEl.lastElementChild;
                if (lastChild && lastChild.tagName == "UL")
                  parentEl.removeChild(lastChild);
              }
              // And reinsert the received ones instead
              addFileNodes(parentPath, JSON.parse(req.responseText));
              if (
                document.getElementById(parentPath).childNodes[0].checked !==
                undefined
              ) {
                document.getElementById(
                  parentPath
                ).childNodes[0].checked = true;
              }
              // If there are more folders to refresh, go ahead
              if (remainingPaths && remainingPaths.length) {
                listPaths(remainingPaths);
              }
            }
          };
        }

        /*
         * Callback after a FS operation was performed.
         * The "req" param is the http request
         * The "path" param is the "affected" (created, moved, renamed, delteted) path, of which the parent must be refreshed
         * In case of move/delete, the "target" path is returned in the response, so that it can be refreshed too
         * Operation      | path (file to be loaded) | req.responseText (between brackets if same as parent of path)
         * ---------------+--------------------------+--------------------------------------------------------------
         * Create file    | created file             | (parent of created file)
         * Create folder  | created folder           | (parent of created folder)
         * Rename file    | target file              | (parent of source file)
         * Move file      | target file              | parent of source file, or remaining ancestor
         ? Rename folder  | target folder            | (parent of source folder)
         ? Move folder    | target folder            | parent of source folder, or remaining ancestor
         * Delete file    |                          | parent of deleted file, or remaining ancestor
         * Delete folder  |                          | parent of deleted folder, or remaining ancestor
         */
        function onOperationComplete(req, path) {
          return function () {
            setLoading(false);
            if (req.status != 200) showHttpError(req);
            else {
              if (path) {
                var parentPath = getParentFolder(path);

                // Refresh returned path, if requested and different from path
                if (req.responseText && req.responseText != parentPath) {
                  refreshPath(req.responseText);
                }

                // Refresh original path
                refreshPath(parentPath);

                // Try to load given path
                attemptLoad(path);
              } else {
                // Delete, only refresh returned path
                refreshPath(req.responseText);
              }
            }
            refreshStatus();
          };
        }

        // Requests

        function httpList(parentPath, remainingPaths) {
          setLoading(true, "Listing '" + parentPath + "'...");
          console.log("httpList", parentPath, remainingPaths);
          // Fetch an updated list
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = onListReceived(xmlHttp, parentPath, remainingPaths);
          xmlHttp.open("GET", "/list?dir=" + parentPath, true);
          xmlHttp.send(null);
        }

        function listPaths(paths) {
          var path = paths.pop();
          if (path) {
            httpList(path, paths);
          }
        }

        this.httpUpload = function (file, path) {
          // setLoading(true, "上传中 '" + path + "'...");
          setLoading(true, language.shangchuanzhong + " '" + path + "'...");
          if (!path.startsWith("/")) path = "/" + path;
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = onOperationComplete(xmlHttp, path);
          var formData = new FormData();
          formData.append("data", file, path);
          xmlHttp.open("POST", "/edit");
          xmlHttp.send(formData);
        };

        this.httpCreate = function (path) {
          setLoading(true, "Creating '" + path + "'...");
          if (!path.startsWith("/")) path = "/" + path;
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = onOperationComplete(xmlHttp, path);
          var formData = new FormData();
          formData.append("path", path);
          xmlHttp.open("PUT", "/edit");
          xmlHttp.send(formData);
        };

        function httpRename(srcPath, dstPath) {
          setLoading(
            true,
            "Renaming '" + srcPath + "' to '" + dstPath + "'..."
          );
          if (!dstPath.startsWith("/")) dstPath = "/" + dstPath;
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = onOperationComplete(xmlHttp, dstPath);
          var formData = new FormData();
          formData.append("path", dstPath);
          formData.append("src", srcPath);
          xmlHttp.open("PUT", "/edit");
          xmlHttp.send(formData);
        }

        function httpDelete(path) {
          setLoading(true, "Deleting '" + path + "'...");
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = onOperationComplete(xmlHttp);
          var formData = new FormData();
          formData.append("path", path);
          xmlHttp.open("DELETE", "/edit");
          xmlHttp.send(formData);
        }

        httpList("/");
        return this;
      }

      /////////////////////////
      // ACE EDITOR MANAGEMENT

      function createEditor(element, file, lang, theme, type) {
        function getLangFromFilename(filename) {
          var lang = "plain";
          var ext = /(?:\.([^.]+))?$/.exec(filename)[1];
          if (ext !== undefined) {
            switch (ext) {
              case "txt":
                lang = "plain";
                break;
              case "htm":
                lang = "html";
                break;
              case "js":
                lang = "javascript";
                break;
              case "c":
                lang = "c_cpp";
                break;
              case "cpp":
                lang = "c_cpp";
                break;
              case "css":
              case "scss":
              case "php":
              case "html":
              case "json":
              case "xml":
                lang = ext;
            }
          }
          return lang;
        }

        if (typeof file === "undefined") file = "/index.htm";

        if (typeof lang === "undefined") {
          lang = getLangFromFilename(file);
        }

        if (typeof theme === "undefined") theme = "textmate";

        if (typeof type === "undefined") {
          type = "text/" + lang;
          if (lang === "c_cpp") type = "text/plain";
        }

        var xmlHttp = null;
        var editor = ace.edit(element);

        function filePosted() {
          setLoading(false);
          if (xmlHttp.status != 200) showHttpError(xmlHttp);
          tree.refreshPath(getParentFolder(file)); // to update size in tree
          refreshStatus();
        }
        function postFile(path, data, type) {
          setLoading(true, "Saving '" + path + "'...");
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = filePosted;
          var formData = new FormData();
          formData.append("data", new Blob([data], { type: type }), path);
          xmlHttp.open("POST", "/edit");
          xmlHttp.send(formData);
        }

        function fileLoaded() {
          setLoading(false);
          document.getElementById("preview").style.display = "none";
          document.getElementById("editor").style.display = "block";
          // document.getElementById("editorButtons").style.display = "inline";
          if (xmlHttp.status == 200) {
            editor.setValue(xmlHttp.responseText);
            const close = document.createElement("div");
            editor.container.prepend(close);
            close.classList.add("show-close");
            close.onclick = showClose;
            editor.clearSelection();
            enableSaveDiscardBtns(false);
          } else tree.clearMainPanel();
        }
        function loadFile(path) {
          setLoading(true, "Loading '" + path + "'...");
          xmlHttp = new XMLHttpRequest();
          xmlHttp.onload = fileLoaded;
          xmlHttp.open("GET", path, true);
          xmlHttp.send(null);
        }

        if (lang !== "plain") editor.getSession().setMode("ace/mode/" + lang);
        editor.setTheme("ace/theme/" + theme);
        editor.$blockScrolling = Infinity;
        editor.getSession().setUseSoftTabs(true);
        editor.getSession().setTabSize(2);
        editor.setHighlightActiveLine(true);
        editor.setShowPrintMargin(false);
        editor.commands.addCommand({
          name: "save",
          bindKey: { win: "Ctrl-S", mac: "Command-S" },
          exec: function (editor) {
            editor.save();
          },
          readOnly: false,
        });
        editor.commands.addCommand({
          name: "showKeyboardShortcuts",
          bindKey: { win: "Ctrl-Alt-h", mac: "Command-Alt-h" },
          exec: function (editor) {
            editor.showShortcuts();
          },
        });

        editor.session.on("change", function (delta) {
          enableSaveDiscardBtns(true);
        });

        editor.loadUrl = function (path) {
          const size = document
            .getElementById(path)
            .getElementsByTagName("i")[0]
            .innerHTML.replace(/[()（）]/g, "");
          const l = size.length;
          const s = size
            .slice(l - 2, l)
            .toLowerCase()
            .replace(/\s*/g, "");
          const n = parseFloat(size);
          if ((s === "kb" && n < 1024) || (s === "b" && n < 1024 * 1024)) {
            document.getElementById("pathInput").value = path;
            enableSaveDiscardBtns(false);
            file = path;
            lang = getLangFromFilename(file);
            type = "text/" + lang;
            if (lang !== "plain")
              editor.getSession().setMode("ace/mode/" + lang);
            loadFile(file);
          }
        };

        editor.save = function () {
          enableSaveDiscardBtns(false);
          postFile(file, editor.getValue() + "", type);
        };

        editor.discard = function () {
          editor.loadUrl(file);
          enableSaveDiscardBtns(false);
        };

        editor.showShortcuts = function () {
          ace.config.loadModule("ace/ext/keybinding_menu", function (module) {
            module.init(editor);
            editor.showKeyboardShortcuts();
          });
        };

        loadFile(file);

        return editor;
      }

      /////////////////////////
      // MAIN ENTRY POINT

      function onBodyLoad() {
        var vars = {};
        var parts = window.location.href.replace(
          /[?&]+([^=&]+)=([^&]*)/gi,
          function (m, key, value) {
            vars[key] = value;
          }
        );
        if (typeof ace != "undefined" && vars.file) {
          var editor = createEditor("editor", vars.file, vars.lang, vars.theme);
        }
        tree = createTree("tree", editor);
        createHeader("header", tree, editor);
        refreshStatus();
      }
    </script>
    <script
      src="/system/ace.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script>
      if (typeof ace == "undefined") {
        console.log("无法加载ace。来自web的js，尝试本地复制");
        var script = document.createElement("script");
        script.src = "/system/ace.js";
        script.async = false;
        document.head.appendChild(script);
      }
    </script>
  </head>
  <body onload="onBodyLoad();">
    <div id="header"></div>
    <div style="flex: 1 1 100%; display: flex; overflow: hidden">
      <div id="tree" style="flex: 0 0 auto; height: 100%; display: flex"></div>
      <div id="tree-show">
        <div id="editor"></div>
        <div id="preview"></div>
      </div>
    </div>
    <div id="loading">
      <span id="loading-msg"></span><br />
      <div class="spinner-anim">
        <span language="jiazaizhong">加载中</span>...
      </div>
    </div>
    <iframe id="download-frame" style="display: none"></iframe>
  </body>
</html>
